<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pacific Shipping Simulation (API)</title>
  <style>
    body { margin: 0; background: #f5f5f5; }
    canvas { display: block; margin: auto; background: #fff; border: 1px solid #ccc; }
    #info { text-align: center; margin: 10px; font-family: Arial; }
  </style>
</head>
<body>

<div id="info">🚢 환태평양 해상 시뮬레이션 (API 연동)</div>
<canvas id="mapCanvas" width="1200" height="800"></canvas>

<script>
const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d");

// 지도 이미지
const mapImage = new Image();
mapImage.src = "https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg";

// API 주소
const API_BASE = "http://127.0.0.1:8080";  // FastAPI 서버 포트

// 위경도 → XY
function latLonToXY(lat, lon, width, height) {
  const x = (lon + 180) * (width / 360);
  const y = (90 - lat) * (height / 180);
  return {x, y};
}

// Port, Ship 데이터 로딩
async function fetchData() {
  const [portsRes, shipRes] = await Promise.all([
    fetch(`${API_BASE}/ports`),
    fetch(`${API_BASE}/ship`)
  ]);
  const ports = await portsRes.json();
  const ship = await shipRes.json();
  drawMap(ports, ship);
}

// 지도와 점 그리기
function drawMap(ports, ship) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);

  // Ports (빨간 점)
  ports.forEach(p => {
    const {x, y} = latLonToXY(p.lat, p.lon, 2000, 1000);
    const adjX = x * (canvas.width / 2000);
    const adjY = y * (canvas.height / 1000);
    ctx.beginPath();
    ctx.arc(adjX, adjY, 6, 0, 2 * Math.PI);
    ctx.fillStyle = "red";
    ctx.fill();
    ctx.fillText(p.port, adjX + 8, adjY - 5);
  });

  // Ship (파란 점)
  const {x, y} = latLonToXY(ship.lat, ship.lon, 2000, 1000);
  const adjX = x * (canvas.width / 2000);
  const adjY = y * (canvas.height / 1000);
  ctx.beginPath();
  ctx.arc(adjX, adjY, 8, 0, 2 * Math.PI);
  ctx.fillStyle = "blue";
  ctx.fill();
}

// 지도 onload 후 주기적으로 API 호출
mapImage.onload = () => {
  fetchData();
  setInterval(fetchData, 5000); // 5초마다 업데이트
};
</script>

</body>
</html>
